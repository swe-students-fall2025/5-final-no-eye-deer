<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Diary - Apawtment</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>

<body class="pattern-bg">

    <header class="navbar">
        <div class="nav-group">
            <span class="logo">Apawtment</span>
            <a href="{{ url_for('profile') }}">Profile</a>
        </div>
    </header>

    <div class="diary-list-wrapper">
        <h1 class="diary-list-title">{{ pet.name }}'s Diary</h1>

        <div class="diary-actions">
            <button class="back-btn" onclick="window.location.href='{{ url_for('profile') }}'">← Back</button>
            <button class="diary-action-btn add"
                    onclick="window.location.href='{{ url_for('add_diary_post', pet_id=str(pet._id)) }}'">
                Add Post
            </button>
            <button class="diary-action-btn delete" id="deleteDiaryBtn" onclick="toggleDeleteMode()">Delete</button>
        </div>

        <div class="diary-grid" id="diaryGrid">

            {% if posts %}
                {% for post in posts %}
                    <article class="diary-post-card"
                             onclick="viewPostDetail(event, '{{ url_for('diary_detail', post_id=str(post._id)) }}')">
                        <span class="delete-diary-icon" onclick="deleteDiaryPost(this, '{{ url_for('delete_diary_post', post_id=str(post._id)) }}')">❌</span>
                        <img src="{{ post.photo_url or url_for('static', filename='images/cat.webp') }}"
                             class="diary-post-photo" alt="Pet photo">
                        <div class="diary-post-content">
                            <h3 class="diary-post-title">{{ post.title }}</h3>
                            <p class="diary-post-time">
                                Posted:
                                {% if post.created_at %}
                                    {{ post.created_at.strftime("%B %d, %Y, %I:%M %p") }}
                                {% else %}
                                    Unknown time
                                {% endif %}
                            </p>
                        </div>
                    </article>
                {% endfor %}
            {% else %}
                <p>No diary posts yet. Click "Add Post" to write the first one.</p>
            {% endif %}

        </div>
    </div>

    <script>
        let deleteDiaryMode = false;

        function addNewPost() {
            window.location.href = '{{ url_for("add_diary_post", pet_id=str(pet._id)) }}';
        }

        function toggleDeleteMode() {
            deleteDiaryMode = !deleteDiaryMode;
            const deleteBtn = document.getElementById('deleteDiaryBtn');
            const diaryGrid = document.getElementById('diaryGrid');

            if (deleteDiaryMode) {
                deleteBtn.textContent = 'Done';
                deleteBtn.style.background = '#c08a1a';
                diaryGrid.classList.add('delete-mode');
            } else {
                deleteBtn.textContent = 'Delete';
                deleteBtn.style.background = '#f5c0c0';
                diaryGrid.classList.remove('delete-mode');
            }
        }

        function deleteDiaryPost(icon, deleteUrl) {
            if (!deleteDiaryMode) return;

            if (confirm('Are you sure you want to delete this post?')) {
                const card = icon.closest('.diary-post-card');
                card.style.opacity = '0';
                card.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    card.remove();
                }, 300);

                fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
            }
        }

        function viewPostDetail(event, detailUrl) {
            if (event.target.classList.contains('delete-diary-icon') ||
                event.target.closest('.delete-diary-icon')) {
                event.stopPropagation();
                return;
            }
            window.location.href = detailUrl;
        }
    </script>

</body>
</html>
